var canvases=[];const NAME_LEN=15;var utils,findContours,arrayToPtr,ptrToArray,models={};function make_random_name(){for(var e="qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890",t=e.length,a="",n=0;n<NAME_LEN;n++)a+=e.charAt(Math.floor(Math.random()*t));return a}function create_canv(e,t){let a=document.createElement("canvas");return a.width=e,a.height=t,a.id=make_random_name(),a.hidden=!0,canvases.push(a),document.body.appendChild(a),a}function crop_and_center_image(e,t){let a=e.width,n=e.height;var r,o;a>n?(o=t/a*n,r=t,console.log(r,o)):(r=t/n*a,o=t);var i=create_canv(r,o).getContext("2d");i.drawImage(e,0,0,r,o);var s=(t-o)/2,c=(t-r)/2,l=create_canv(t,t),d=l.getContext("2d");d.fillStyle="black",d.fillRect(0,0,t,t);for(var f=0;f<t;f++)for(var u=0;u<t;u++)if(f>=c&&f<c+r&&u>=s&&u<s+o){var v=i.getImageData(f-c,u-s,1,1);0!=v.data[0]&&d.putImageData(v,f,u)}return l}async function predict(e,t,a){var n;models[t]?n=models[t]:(n=await tf.loadLayersModel(a+"/"+t+"/model.json"),models[t]=n);var r=process_image(e,28);let o=tf.tensor2d(r);o=o.reshape([-1,28,28,1]);let i=n.predict(o);return console.log(i),Array.from(i.dataSync())[0]}function image_to_array(e,t){for(var a=e.getContext("2d"),n=[],r=0;r<t;r++){for(var o=[],i=0;i<t;i++){a.getImageData(i,r,1,1).data[0]>0?o.push(255):o.push(0)}n.push(o)}return n}function process_image(e,t){var a=e.getContext("2d"),n=new Int32Array(a.getImageData(0,0,e.width,e.height).data);console.log(e.width+" "+e.height);let r=ptrToArray(findContours(arrayToPtr(n),e.width,e.height),4);console.log(r);var o=0,i=0,s=r[2]-r[0],c=r[3]-r[1];s<128&&(o=128-s),c<128&&(i=128-c);var l=create_canv(r[2]-r[0]+o,r[3]-r[1]+i);l.getContext("2d").fillStyle="black",l.getContext("2d").fillRect(0,0,l.width,l.height);var d=r[0],f=r[1],u=r[2]-r[0],v=r[3]-r[1];return l.getContext("2d").drawImage(e,d-o/2,f-i/2,u+d+o/2,v+f+i/2,0,0,u+d+o/2,v+f+i/2),image_to_array(crop_and_center_image(l,t),t)}function clear_canvases(){for(var e=0;e<canvases.length;e++)canvases[e].remove();canvases=[]}function createPredictor(e,t,a,n){var r;(r=new XMLHttpRequest).responseType="arraybuffer",r.addEventListener("load",function(){var e=r.response;Utils.wasmBinary=e,(async()=>{utils=await Utils({wasmBinary:Utils.wasmBinary}),findContours=utils.cwrap("findContours",null,["number","number","number"]),arrayToPtr=function(e){var t=utils._malloc(4*e.length);return utils.HEAP32.set(e,t/4),t},ptrToArray=function(e,t){var a=new Int32Array(t),n=e/4;return a.set(utils.HEAP32.subarray(n,n+t)),a}})()}),r.open("GET","wasm_utils.wasm"),r.send();let o=document.createElement("canvas");o.width=t,o.height=a,o.id=make_random_name();var i=o.getContext("2d"),s=o.width,c=o.height;i.fillStyle="black",i.fillRect(0,0,s,c),i.lineCap="round",i.lineWidth=n;var l={x:0,y:0},d=!1;o.addEventListener("pointerdown",function(e){l.x=e.pageX-this.offsetLeft,l.y=e.pageY-this.offsetTop,d=!0}),o.addEventListener("pointermove",function(e){1==d&&(l.x=e.pageX-this.offsetLeft,l.y=e.pageY-this.offsetTop,i.fillStyle="white",i.strokeStyle="#FFFFFF",i.beginPath(),i.moveTo(l.x,l.y),i.lineTo(l.x-e.movementX,l.y-e.movementY),i.stroke(),i.closePath())}),o.addEventListener("pointerup",function(e){l.x=e.pageX-this.offsetLeft,l.y=e.pageY-this.offsetTop,d=!1}),e.appendChild(o);var f={};return f.main_canv=o,f.canvases=[],f.clear_canvas=function(){var e=this.main_canv.getContext("2d");e.fillStyle="black",e.fillRect(0,0,s,c)},f.clear_canvases=clear_canvases,f.predict=function(e,t){return predict(this.main_canv,e,t)},f}
