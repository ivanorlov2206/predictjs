var canvases=[];const NAME_LEN=15;var utils,findContours,arrayToPtr,ptrToArray,models={};function make_random_name(){for(var e="qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890",t=e.length,a="",n=0;n<NAME_LEN;n++)a+=e.charAt(Math.floor(Math.random()*t));return a}function create_canv(e,t){let a=document.createElement("canvas");return a.width=e,a.height=t,a.id=make_random_name(),a.hidden=!0,canvases.push(a),document.body.appendChild(a),a}function crop_and_center_image(e,t){let a=e.width,n=e.height;var r,o;a>n?(o=t/a*n,r=t,console.log(r,o)):(r=t/n*a,o=t);var i=create_canv(r,o).getContext("2d");i.drawImage(e,0,0,r,o);var s=(t-o)/2,c=(t-r)/2,l=create_canv(t,t),d=l.getContext("2d");d.fillStyle="black",d.fillRect(0,0,t,t);for(var f=0;f<t;f++)for(var u=0;u<t;u++)if(f>=c&&f<c+r&&u>=s&&u<s+o){var h=i.getImageData(f-c,u-s,1,1);0!=h.data[0]&&d.putImageData(h,f,u)}return l}async function predict(e,t,a){var n;models[t]?n=models[t]:(n=await tf.loadLayersModel(a+"/"+t+"/model.json"),models[t]=n);var r=process_image(e,28);let o=tf.tensor2d(r);o=o.reshape([-1,28,28,1]);let i=n.predict(o);return console.log(i),Array.from(i.dataSync())[0]}function image_to_array(e,t){for(var a=e.getContext("2d"),n=[],r=0;r<t;r++){for(var o=[],i=0;i<t;i++){a.getImageData(i,r,1,1).data[0]>0?o.push(255):o.push(0)}n.push(o)}return n}function process_image(e,t){var a=e.getContext("2d"),n=new Int32Array(a.getImageData(0,0,e.width,e.height).data);console.log(e.width+" "+e.height);let r=ptrToArray(findContours(arrayToPtr(n),e.width,e.height),4);console.log(r);var o=create_canv(r[2]-r[0],r[3]-r[1]),i=r[0],s=r[1],c=r[2]-r[0],l=r[3]-r[1];return o.getContext("2d").drawImage(e,i,s,c+i,l+s,0,0,c+i,l+s),image_to_array(crop_and_center_image(o,t),t)}function clear_canvases(){for(var e=0;e<canvases.length;e++)document.body.removeChild(canvases[e]);canvases=[]}function createPredictor(e,t,a){var n;(n=new XMLHttpRequest).responseType="arraybuffer",n.addEventListener("load",function(){var e=n.response;Utils.wasmBinary=e,(async()=>{utils=await Utils({wasmBinary:Utils.wasmBinary}),findContours=utils.cwrap("findContours",null,["number","number","number"]),arrayToPtr=function(e){var t=utils._malloc(4*e.length);return utils.HEAP32.set(e,t/4),t},ptrToArray=function(e,t){var a=new Int32Array(t),n=e/4;return a.set(utils.HEAP32.subarray(n,n+t)),a}})()}),n.open("GET","wasm_utils.wasm"),n.send();let r=document.createElement("canvas");r.width=t,r.height=a,r.id=make_random_name();var o=r.getContext("2d"),i=r.width,s=r.height;o.fillStyle="black",o.fillRect(0,0,i,s);var c={x:0,y:0},l=!1;r.addEventListener("pointerdown",function(e){c.x=e.pageX-this.offsetLeft,c.y=e.pageY-this.offsetTop,l=!0}),r.addEventListener("pointermove",function(e){1==l&&(c.x=e.pageX-this.offsetLeft,c.y=e.pageY-this.offsetTop,o.fillStyle="white",o.beginPath(),o.ellipse(c.x,c.y,6,6,0,0,2*Math.PI),o.fill())}),r.addEventListener("pointerup",function(e){c.x=e.pageX-this.offsetLeft,c.y=e.pageY-this.offsetTop,l=!1}),canvases.push(r),e.appendChild(r);var d={};return d.main_canv=r,d.canvases=[],d.clear_canvas=function(){var e=this.main_canv.getContext("2d");e.fillStyle="black",e.fillRect(0,0,i,s)},d.predict=function(e,t){return predict(this.main_canv,e,t)},d}
