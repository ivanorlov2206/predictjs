var canvases=[];const NAME_LEN=15;var models={};function make_random_name(){for(var e="qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890",t=e.length,a="",n=0;n<NAME_LEN;n++)a+=e.charAt(Math.floor(Math.random()*t));return a}function create_canv(e,t){let a=document.createElement("canvas");return a.width=e,a.height=t,a.id=make_random_name(),a.hidden=!0,canvases.push(a),document.body.appendChild(a),a}function find_contours(e){for(var t=e.getContext("2d"),a=e.width,n=e.height,r=a,o=n,i=0,c=0,d=0;d<n;d++)for(var s=0;s<a;s++){t.getImageData(s,d,1,1).data[0]>0&&(s<r&&(r=s),s>i&&(i=s),d<o&&(o=d),d>c&&(c=d))}return[r,o,i,c]}function crop_and_center_image(e,t){let a=e.width,n=e.height;var r,o;a>n?(o=t/a*n,r=t,console.log(r,o)):(r=t/n*a,o=t);var i=create_canv(r,o).getContext("2d");i.drawImage(e,0,0,r,o);var c=(t-o)/2,d=(t-r)/2,s=create_canv(t,t),f=s.getContext("2d");f.fillStyle="black",f.fillRect(0,0,t,t);for(var l=0;l<t;l++)for(var v=0;v<t;v++)if(l>=d&&l<d+r&&v>=c&&v<c+o){var h=i.getImageData(l-d,v-c,1,1);0!=h.data[0]&&f.putImageData(h,l,v)}return s}async function predict(e,t,a){var n;models[t]?n=models[t]:(n=await tf.loadLayersModel(a+"/"+t+"/model.json"),models[t]=n);var r=process_image(e,28);let o=tf.tensor2d(r);o=o.reshape([-1,28,28,1]);let i=n.predict(o);return console.log(i),Array.from(i.dataSync())[0]}function image_to_array(e,t){for(var a=e.getContext("2d"),n=[],r=0;r<t;r++){for(var o=[],i=0;i<t;i++){a.getImageData(i,r,1,1).data[0]>0?o.push(255):o.push(0)}n.push(o)}return n}function process_image(e,t){let a=find_contours(e);var n=create_canv(a[2]-a[0],a[3]-a[1]),r=a[0],o=a[1],i=a[2]-a[0],c=a[3]-a[1];return n.getContext("2d").drawImage(e,r,o,i+r,c+o,0,0,i+r,c+o),image_to_array(crop_and_center_image(n,t),t)}function clear_canvases(){for(var e=0;e<canvases.length;e++)document.body.removeChild(canvases[e]);canvases=[]}function createPredictor(e,t,a){let n=document.createElement("canvas");n.width=t,n.height=a,n.id=make_random_name();var r=n.getContext("2d"),o=n.width,i=n.height;r.fillStyle="black",r.fillRect(0,0,o,i);var c={x:0,y:0},d=!1;n.addEventListener("pointerdown",function(e){c.x=e.pageX-this.offsetLeft,c.y=e.pageY-this.offsetTop,d=!0}),n.addEventListener("pointermove",function(e){1==d&&(c.x=e.pageX-this.offsetLeft,c.y=e.pageY-this.offsetTop,r.fillStyle="white",r.beginPath(),r.ellipse(c.x,c.y,6,6,0,0,2*Math.PI),r.fill())}),n.addEventListener("pointerup",function(e){c.x=e.pageX-this.offsetLeft,c.y=e.pageY-this.offsetTop,d=!1}),canvases.push(n),e.appendChild(n);var s={};return s.main_canv=n,s.canvases=[],s.clear_canvas=function(){var e=this.main_canv.getContext("2d");e.fillStyle="black",e.fillRect(0,0,o,i)},s.predict=function(e,t){return predict(this.main_canv,e,t)},s}
